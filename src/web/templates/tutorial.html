{% extends "base.html" %}

{% block title %}{{ metadata.title }} - TutorialMaker{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div id="loading-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.95); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;">
    <div style="text-align: center;">
        <div style="font-size: 24px; font-weight: bold; color: #007bff; margin-bottom: 20px;">Loading Tutorial...</div>
        <div style="width: 300px; height: 4px; background: #e0e0e0; border-radius: 2px; overflow: hidden;">
            <div id="loading-progress" style="width: 0%; height: 100%; background: linear-gradient(90deg, #007bff, #0056b3); transition: width 0.3s ease;"></div>
        </div>
        <div id="loading-status" style="margin-top: 15px; color: #666; font-size: 14px;">Initializing...</div>
    </div>
</div>

<!-- Sticky Header with Action Buttons -->
<div class="sticky-header">
    <div class="tutorial-actions-bar">
        <div class="tutorial-title-inline">
            <h2 id="tutorial-title" contenteditable="true">{{ metadata.title or 'Untitled Tutorial' }}</h2>
        </div>
        <div class="tutorial-actions">
            <button onclick="saveTutorial()" class="btn btn-success">Save Changes</button>

            <!-- Export Dropdown -->
            <div class="dropdown-container">
                <button onclick="toggleExportDropdown()" class="btn">Export Selected</button>
                <div id="export-dropdown" class="dropdown-menu">
                    <label><input type="checkbox" id="export-html" checked> HTML</label>
                    <label><input type="checkbox" id="export-word"> Word</label>
                    <label><input type="checkbox" id="export-markdown"> Markdown</label>
                    <button onclick="exportTutorial()" class="btn btn-success" style="margin-top: 10px; width: 100%;">Export Now</button>
                </div>
            </div>

            <button onclick="previewTutorial()" class="btn">Preview</button>

            <!-- Formatting Help Dropdown -->
            <div class="dropdown-container">
                <button onclick="toggleFormattingDropdown()" class="btn btn-secondary">Formatting</button>
                <div id="formatting-dropdown" class="dropdown-menu formatting-dropdown">
                    <h4>Formatting Guide:</h4>
                    <div class="formatting-examples">
                        <div><strong>**bold text**</strong> → <strong>bold text</strong></div>
                        <div><strong>*italic text*</strong> → <em>italic text</em></div>
                        <div><strong>`code`</strong> → <code>code</code></div>
                        <div><strong>```code block```</strong> → <pre>code block</pre></div>
                        <div><strong>&lt;br&gt;</strong> → line break</div>
                        <div><strong>Enter key</strong> → new paragraph</div>
                    </div>
                </div>
            </div>

            <a href="/" class="btn btn-secondary">Back to List</a>
        </div>
    </div>
</div>

<!-- Tutorial Details Section (scrolls normally) -->
<div class="tutorial-details">
    <div class="tutorial-meta">
        <span><strong>Steps:</strong> <span id="step-count">{{ metadata.step_count }}</span></span>
        <span><strong>Duration:</strong> {{ "%.1f"|format(metadata.duration or 0) }}s</span>
        <span><strong>Status:</strong> {{ (metadata.status or 'unknown').title() }}</span>
        <span><strong>Created:</strong> {{ (metadata.created_at or 0)|timestamp_to_date }}</span>
    </div>

    <div style="margin-top: 20px;">
        <label for="tutorial-description"><strong>Description:</strong></label>
        <textarea id="tutorial-description" style="width: 100%; min-height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px;" placeholder="Add a description for this tutorial...">{{ metadata.description or '' }}</textarea>
    </div>
</div>

<div class="tutorial-steps">
    <h3>Tutorial Steps</h3>
    <div id="steps-container">
        {% for step in steps %}
        <div class="tutorial-step" data-step-id="{{ step.step_id }}">
            <div class="step-header">
                <span class="step-number">{{ step.step_number }}</span>
                <button class="delete-step" onclick="deleteStep('{{ step.step_id }}')" title="Delete this step">×</button>
            </div>
            <div class="step-content">
                <div class="step-description" contenteditable="true" data-original="{{ step.description }}">{{ step.description|format_description }}</div>
                {% if step.screenshot_path and step.screenshot_path != '' %}
                <div class="screenshot-container">
                    {% set screenshot_filename = step.screenshot_path.split('/')[-1] if (step.screenshot_path and '/' in step.screenshot_path|string) else (step.screenshot_path|string) %}
                    <img src="/screenshots/{{ tutorial_id }}/{{ screenshot_filename }}" 
                         alt="Step {{ step.step_number }} screenshot" 
                         class="step-screenshot"
                         onclick="toggleScreenshotSize(this)">
                    
                    {% if step.coordinates_pct and step.coordinates_pct|length >= 2 %}
                    <div class="click-indicator" style="left: calc({{ (step.coordinates_pct[0] * 100)|round(1) }}% - 20px); top: calc({{ (step.coordinates_pct[1] * 100)|round(1) }}% - 20px);">
                        <div class="click-circle"></div>
                    </div>
                    {% elif step.coordinates and step.coordinates|length >= 2 %}
                    {# Fallback for legacy data - need to calculate percentage from image dimensions #}
                    <div class="click-indicator legacy-coords" data-x="{{ step.coordinates[0] }}" data-y="{{ step.coordinates[1] }}">
                        <div class="click-circle"></div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                <div class="step-metadata">
                    <!-- Debug metadata removed for cleaner tutorials -->
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/css/tutorial.css">
{% endblock %}

{% block scripts %}
// Configuration object passed from template to JavaScript
const tutorialConfig = {
    tutorialId: '{{ tutorial_id }}',
    title: '{{ metadata.title }}',
    stepsCount: {{ steps|length }},
    status: '{{ metadata.status }}',
    createdAt: '{{ metadata.created_at }}',
    steps: {{ steps|tojson }}
};
    </script>
    <script src="/static/js/tutorial.js"></script>
    <script>
{% endblock %}