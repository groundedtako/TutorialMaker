{% extends "base.html" %}

{% block title %}{{ metadata.title }} - TutorialMaker{% endblock %}

{% block content %}
<!-- Sticky Header with Action Buttons -->
<div class="sticky-header">
    <div class="tutorial-actions-bar">
        <div class="tutorial-title-inline">
            <h2 id="tutorial-title" contenteditable="true">{{ metadata.title or 'Untitled Tutorial' }}</h2>
        </div>
        <div class="tutorial-actions">
            <button onclick="saveTutorial()" class="btn btn-success">Save Changes</button>
            <button onclick="exportTutorial()" class="btn">Export</button>
            <a href="/" class="btn btn-secondary">Back to List</a>
        </div>
    </div>
    <div class="formatting-help">
        <button class="help-toggle" onclick="toggleFormattingHelp()">
            <span id="help-icon">?</span> Formatting Help
        </button>
        <div id="formatting-help-content" class="help-content" style="display: none;">
            <div class="help-grid">
                <div class="help-item">
                    <strong>Bold:</strong> <code>**text**</code>
                </div>
                <div class="help-item">
                    <strong>Italic:</strong> <code>*text*</code>
                </div>
                <div class="help-item">
                    <strong>Code:</strong> <code>`code`</code>
                </div>
                <div class="help-item">
                    <strong>Code Block:</strong> <code>```code```</code>
                </div>
                <div class="help-item">
                    <strong>Line Break:</strong> Press <kbd>Enter</kbd> or type <code>&lt;br&gt;</code>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tutorial Details Section (scrolls normally) -->
<div class="tutorial-details">
    <div class="tutorial-meta">
        <span><strong>Steps:</strong> <span id="step-count">{{ metadata.step_count }}</span></span>
        <span><strong>Duration:</strong> {{ "%.1f"|format(metadata.duration or 0) }}s</span>
        <span><strong>Status:</strong> {{ (metadata.status or 'unknown').title() }}</span>
        <span><strong>Created:</strong> {{ (metadata.created_at or 0)|timestamp_to_date }}</span>
    </div>

    <div style="margin-top: 20px;">
        <label for="tutorial-description"><strong>Description:</strong></label>
        <textarea id="tutorial-description" style="width: 100%; min-height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px;" placeholder="Add a description for this tutorial...">{{ metadata.description or '' }}</textarea>
    </div>
</div>

<div class="tutorial-steps">
    <h3>Tutorial Steps</h3>
    <div id="steps-container">
        {% for step in steps %}
        <div class="tutorial-step" data-step-id="{{ step.step_id }}">
            <div class="step-header">
                <span class="step-number">{{ step.step_number }}</span>
                <button class="delete-step" onclick="deleteStep('{{ step.step_id }}')" title="Delete this step">Ã—</button>
            </div>
            <div class="step-content">
                <div class="step-description" contenteditable="true" data-original="{{ step.description }}">{{ step.description|format_description }}</div>
                {% if step.screenshot_path and step.screenshot_path != '' %}
                <div class="screenshot-container">
                    {% set screenshot_filename = step.screenshot_path.split('/')[-1] if (step.screenshot_path and '/' in step.screenshot_path|string) else (step.screenshot_path|string) %}
                    <img src="/screenshots/{{ tutorial_id }}/{{ screenshot_filename }}" 
                         alt="Step {{ step.step_number }} screenshot" 
                         class="step-screenshot"
                         onclick="toggleScreenshotSize(this)">
                    
                    {% if step.coordinates_pct and step.coordinates_pct|length >= 2 %}
                    <div class="click-indicator" style="left: calc({{ (step.coordinates_pct[0] * 100)|round(1) }}% - 20px); top: calc({{ (step.coordinates_pct[1] * 100)|round(1) }}% - 20px);">
                        <div class="click-circle"></div>
                    </div>
                    {% elif step.coordinates and step.coordinates|length >= 2 %}
                    {# Fallback for legacy data - need to calculate percentage from image dimensions #}
                    <div class="click-indicator legacy-coords" data-x="{{ step.coordinates[0] }}" data-y="{{ step.coordinates[1] }}">
                        <div class="click-circle"></div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                <div class="step-metadata">
                    <!-- Debug metadata removed for cleaner tutorials -->
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div class="export-controls">
    <h3>Export Options</h3>
    <div style="margin-bottom: 15px;">
        <label style="margin-left: 20px;">
            <input type="checkbox" id="export-html" checked> HTML
        </label>
        <label style="margin-left: 20px;">
            <input type="checkbox" id="export-word"> Word Document
        </label>
        <label style="margin-left: 20px;">
            <input type="checkbox" id="export-markdown"> Markdown
        </label>
    </div>
    <button onclick="exportTutorial()" class="btn btn-success">Export Selected Formats</button>
    <button onclick="previewTutorial()" class="btn btn-secondary">Preview Tutorial</button>
</div>
{% endblock %}

{% block head %}
<style>
    /* Sticky header for action buttons */
    .sticky-header {
        position: sticky;
        top: 0;
        background: white;
        z-index: 100;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-bottom: 2px solid #007bff;
        margin: -20px -20px 20px -20px; /* Extend to edges of container */
        padding: 15px 20px;
    }

    .tutorial-actions-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .tutorial-title-inline h2 {
        margin: 0;
        font-size: 1.3rem;
        padding: 5px 10px;
        border-radius: 4px;
        min-width: 200px;
        display: inline-block;
    }

    .tutorial-title-inline h2:focus {
        outline: none;
        border: 1px solid #007bff;
        background: rgba(0,123,255,0.05);
    }

    .tutorial-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        flex-shrink: 0;
    }

    /* Formatting Help Section */
    .formatting-help {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #e9ecef;
    }

    .help-toggle {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        color: #495057;
        transition: all 0.2s;
    }

    .help-toggle:hover {
        background: #e9ecef;
        border-color: #007bff;
        color: #007bff;
    }

    #help-icon {
        display: inline-block;
        background: #007bff;
        color: white;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        text-align: center;
        line-height: 18px;
        font-size: 12px;
        font-weight: bold;
        margin-right: 5px;
    }

    .help-content {
        margin-top: 10px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 6px;
        border: 1px solid #dee2e6;
    }

    .help-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
    }

    .help-item {
        font-size: 0.85rem;
        color: #495057;
    }

    .help-item code {
        background: #e9ecef;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        color: #d63384;
    }

    .help-item kbd {
        background: #fff;
        border: 1px solid #adb5bd;
        border-radius: 3px;
        padding: 2px 6px;
        font-family: 'Courier New', monospace;
        font-size: 0.85em;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    /* Tutorial details section */
    .tutorial-details {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .tutorial-meta {
        color: #666;
        font-size: 0.9rem;
    }

    .tutorial-meta span {
        margin-right: 20px;
    }
    
    .tutorial-step {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        margin-bottom: 20px;
        overflow: hidden;
        position: relative;
        transition: all 0.3s ease;
    }
    
    .tutorial-step.deleted {
        opacity: 0.5;
        transform: scale(0.95);
    }
    
    .step-header {
        background: #007bff;
        color: white;
        padding: 10px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .step-number {
        font-weight: bold;
        font-size: 1.1em;
    }
    
    .delete-step {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
    }
    
    .delete-step:hover {
        background: rgba(255,255,255,0.3);
    }
    
    .step-content {
        padding: 20px;
    }
    
    .step-description {
        font-size: 1.1em;
        margin-bottom: 15px;
        min-height: 25px;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid transparent;
        transition: all 0.2s;
        white-space: pre-wrap;
        word-wrap: break-word;
        line-height: 1.5;
    }
    
    .step-description pre {
        margin: 8px 0;
        white-space: pre-wrap;
    }
    
    .step-description code {
        font-size: 0.9em;
    }
    
    .step-description strong {
        font-weight: 600;
    }
    
    .step-description em {
        font-style: italic;
    }
    
    .step-description:focus {
        outline: none;
        border-color: #007bff;
        background: white;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
    }
    
    .step-description:hover {
        background: rgba(255,255,255,0.7);
    }
    
    .screenshot-container {
        position: relative;
        display: inline-block;
        margin-bottom: 15px;
        text-align: center;
    }
    
    .click-indicator {
        position: absolute;
        width: 40px;
        height: 40px;
        pointer-events: none;
        z-index: 10;
    }
    
    .click-circle {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: rgba(59, 130, 246, 0.3);
        border: 2px solid rgba(59, 130, 246, 0.7);
        opacity: 0.5;
        transform: scale(1);
        transition: all 0.3s ease;
    }
    
    /* Animation that triggers when step comes into view */
    .step-visible .click-circle {
        animation: clickContract 1.5s ease-out forwards;
    }
    
    /* After animation completes, maintain visible state */
    .step-animation-complete .click-circle {
        opacity: 0.6 !important;
        transform: scale(1) !important;
    }
    
    @keyframes clickContract {
        0% {
            transform: scale(3);
            opacity: 0.8;
        }
        50% {
            transform: scale(1.2);
            opacity: 0.7;
        }
        100% {
            transform: scale(1);
            opacity: 0.6;
        }
    }
    
    /* Hover effect to make indicator more visible */
    .tutorial-step:hover .click-circle {
        opacity: 0.9 !important;
        transform: scale(1.1) !important;
        transition: all 0.2s ease;
    }
    
    .step-screenshot {
        max-width: 100%;
        height: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        transition: transform 0.2s;
    }
    
    .step-screenshot:hover {
        transform: scale(1.02);
    }
    
    .step-screenshot.fullsize {
        max-width: none;
        width: auto;
        max-height: 80vh;
        transform: scale(1);
    }
    
    .step-metadata {
        font-size: 0.85em;
        color: #666;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }
    
    .export-controls {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-top: 20px;
    }
    
    .export-controls label {
        cursor: pointer;
        user-select: none;
    }

    .changed {
        background: rgba(255,193,7,0.1) !important;
        border-color: #ffc107 !important;
    }
    
    @media (max-width: 768px) {
        .tutorial-header > div {
            flex-direction: column;
            gap: 15px;
        }
        
        .tutorial-actions {
            width: 100%;
        }
        
        .tutorial-meta span {
            display: block;
            margin-right: 0;
            margin-bottom: 5px;
        }
        
        .step-metadata {
            flex-direction: column;
            gap: 5px;
        }
    }
</style>
{% endblock %}

{% block scripts %}
let hasChanges = false;
let originalData = {};

// Store original data
document.addEventListener('DOMContentLoaded', function() {
    originalData.title = document.getElementById('tutorial-title').textContent;
    originalData.description = document.getElementById('tutorial-description').value;
    originalData.steps = {};
    
    document.querySelectorAll('.step-description').forEach(desc => {
        const stepId = desc.closest('.tutorial-step').dataset.stepId;
        originalData.steps[stepId] = desc.textContent;
    });
    
    // Initialize animated click indicators
    initializeClickAnimations();
});

// Initialize animated click indicators with intersection observer
function initializeClickAnimations() {
    // Handle legacy coordinates (convert absolute to percentage)
    document.querySelectorAll('.click-indicator.legacy-coords').forEach(indicator => {
        const img = indicator.closest('.screenshot-container').querySelector('.step-screenshot');
        const x = parseFloat(indicator.dataset.x);
        const y = parseFloat(indicator.dataset.y);
        
        img.onload = function() {
            const x_pct = (x / img.naturalWidth) * 100;
            const y_pct = (y / img.naturalHeight) * 100;
            indicator.style.left = `calc(${x_pct}% - 20px)`;
            indicator.style.top = `calc(${y_pct}% - 20px)`;
            indicator.classList.remove('legacy-coords');
        };
        
        // If image is already loaded
        if (img.complete && img.naturalWidth > 0) {
            img.onload();
        }
    });
    
    // Intersection Observer for click animations - triggers EVERY time step comes into view
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('step-visible');
                // Trigger animation with slight delay for better effect
                setTimeout(() => {
                    const clickCircles = entry.target.querySelectorAll('.click-circle');
                    clickCircles.forEach(circle => {
                        // Reset animation by removing and re-adding the class
                        circle.style.animation = 'none';
                        circle.offsetHeight; // Force reflow
                        circle.style.animation = 'clickContract 1.5s ease-out forwards';
                        
                        // Add persistent state after animation completes
                        setTimeout(() => {
                            entry.target.classList.add('step-animation-complete');
                        }, 1500);
                    });
                }, 200);
            } else {
                // Keep the visible state even when out of view, only remove if user scrolls way past
                // This ensures circles remain visible once animated
                const rect = entry.target.getBoundingClientRect();
                if (rect.top > window.innerHeight + 200 || rect.bottom < -200) {
                    entry.target.classList.remove('step-visible', 'step-animation-complete');
                }
            }
        });
    }, {
        threshold: 0.3, // Trigger when 30% of step is visible
        rootMargin: '0px 0px -50px 0px' // Account for header/footer
    });
    
    // Observe all tutorial steps
    document.querySelectorAll('.tutorial-step').forEach(step => {
        observer.observe(step);
    });
}

// Track changes
document.getElementById('tutorial-title').addEventListener('input', markChanged);
document.getElementById('tutorial-description').addEventListener('input', markChanged);

document.querySelectorAll('.step-description').forEach(desc => {
    desc.addEventListener('input', function() {
        markChanged();
        this.classList.add('changed');
    });
});

function markChanged() {
    hasChanges = true;
    document.querySelector('[onclick="saveTutorial()"]').style.background = '#ffc107';
    document.querySelector('[onclick="saveTutorial()"]').textContent = 'Save Changes *';
}

function toggleScreenshotSize(img) {
    img.classList.toggle('fullsize');
}

function toggleFormattingHelp() {
    const helpContent = document.getElementById('formatting-help-content');
    if (helpContent.style.display === 'none') {
        helpContent.style.display = 'block';
    } else {
        helpContent.style.display = 'none';
    }
}

async function deleteStep(stepId) {
    if (!confirm('Are you sure you want to delete this step?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/tutorial/{{ tutorial_id }}/delete_step`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                step_id: stepId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            const stepElement = document.querySelector(`[data-step-id="${stepId}"]`);
            stepElement.classList.add('deleted');
            
            setTimeout(() => {
                stepElement.remove();
                updateStepNumbers();
                document.getElementById('step-count').textContent = result.new_step_count;
                showAlert('Step deleted successfully', 'success');
            }, 300);
        } else {
            showAlert('Failed to delete step: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showAlert('Delete failed: ' + error.message, 'error');
    }
}

function updateStepNumbers() {
    const steps = document.querySelectorAll('.tutorial-step:not(.deleted)');
    steps.forEach((step, index) => {
        const stepNumber = step.querySelector('.step-number');
        stepNumber.textContent = index + 1;
    });
}

// Utility function to disable/enable action buttons
function setActionButtonsDisabled(disabled) {
    const saveButton = document.querySelector('[onclick*="saveTutorial()"]');
    const exportButton = document.querySelector('[onclick*="exportTutorial()"]');
    const previewButton = document.querySelector('[onclick*="previewTutorial()"]');
    
    if (saveButton) {
        saveButton.disabled = disabled;
        saveButton.textContent = disabled ? 'Saving...' : 'Save Changes';
    }
    
    if (exportButton) {
        exportButton.disabled = disabled;
        exportButton.textContent = disabled ? 'Exporting...' : 'Export Selected Formats';
    }
    
    if (previewButton) {
        previewButton.disabled = disabled;
    }
}

// Helper function to convert HTML from contenteditable to plain text with newlines
function htmlToText(element) {
    // Clone the element to avoid modifying the original
    const clone = element.cloneNode(true);

    // Replace <br> tags with newlines
    clone.querySelectorAll('br').forEach(br => {
        br.replaceWith('\n');
    });

    // Replace </div> with newlines (contenteditable creates divs for new lines in some browsers)
    const html = clone.innerHTML;
    const textWithNewlines = html
        .replace(/<div>/gi, '\n')
        .replace(/<\/div>/gi, '')
        .replace(/<br\s*\/?>/gi, '\n')
        .replace(/&nbsp;/g, ' ')
        .replace(/<[^>]+>/g, ''); // Remove remaining HTML tags

    // Decode HTML entities
    const textarea = document.createElement('textarea');
    textarea.innerHTML = textWithNewlines;
    return textarea.value;
}

async function saveTutorial() {
    // Disable buttons during save operation
    setActionButtonsDisabled(true);

    try {
        const title = document.getElementById('tutorial-title').textContent.trim();
        const description = document.getElementById('tutorial-description').value.trim();

        const steps = [];
        document.querySelectorAll('.tutorial-step:not(.deleted)').forEach(stepEl => {
            const stepId = stepEl.dataset.stepId;
            const descriptionEl = stepEl.querySelector('.step-description');

            // Convert HTML to text while preserving newlines
            const descriptionText = htmlToText(descriptionEl);

            steps.push({
                step_id: stepId,
                description: descriptionText.trim()
            });
        });
        
        const response = await fetch(`/api/tutorial/{{ tutorial_id }}/update`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                metadata: {
                    title: title,
                    description: description
                },
                steps: steps
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            hasChanges = false;
            document.querySelector('[onclick="saveTutorial()"]').style.background = '#28a745';
            document.querySelector('[onclick="saveTutorial()"]').textContent = 'Save Changes';
            
            // Remove change indicators
            document.querySelectorAll('.changed').forEach(el => {
                el.classList.remove('changed');
            });
            
            showAlert('Tutorial saved successfully!', 'success');
        } else {
            showAlert('Save failed: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showAlert('Save failed: ' + error.message, 'error');
    } finally {
        // Re-enable buttons after save completes or fails
        setActionButtonsDisabled(false);
    }
}

async function exportTutorial() {
    const formats = [];
    if (document.getElementById('export-html').checked) formats.push('html');
    if (document.getElementById('export-word').checked) formats.push('word');
    if (document.getElementById('export-markdown').checked) formats.push('markdown');
    
    if (formats.length === 0) {
        showAlert('Please select at least one export format', 'error');
        return;
    }
    
    // Disable buttons during export operation
    setActionButtonsDisabled(true);
    
    try {
        showAlert(`Exporting to ${formats.join(', ')}...`, 'info');
        
        const response = await fetch(`/api/tutorial/{{ tutorial_id }}/export`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                formats: formats
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('Tutorial exported successfully!', 'success');
            
            // Show results
            let message = 'Export completed:\\n';
            for (const [format, path] of Object.entries(result.results)) {
                if (path.startsWith('Error:')) {
                    message += `â€¢ ${format.toUpperCase()}: ${path}\\n`;
                } else {
                    const filename = path.split('/').pop();
                    message += `â€¢ ${format.toUpperCase()}: ${filename}\\n`;
                }
            }
            
            showAlert(message, 'success');
        } else {
            showAlert('Export failed: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showAlert('Export failed: ' + error.message, 'error');
    } finally {
        // Re-enable buttons after export completes or fails
        setActionButtonsDisabled(false);
    }
}

function previewTutorial() {
    // Generate live preview of current tutorial
    const previewUrl = `/preview/{{ tutorial_id }}`;
    window.open(previewUrl, '_blank');
}

// Warn about unsaved changes
window.addEventListener('beforeunload', function(e) {
    if (hasChanges) {
        e.preventDefault();
        e.returnValue = '';
    }
});

// Frontend logging for tutorial page
console.group('Tutorial Page Loaded');
console.log('Tutorial ID:', '{{ tutorial_id }}');
console.log('Title:', '{{ metadata.title }}');
console.log('Steps count:', {{ steps|length }});
console.log('Status:', '{{ metadata.status }}');
console.log('Created:', '{{ metadata.created_at }}');
console.log('Page loaded at:', new Date().toISOString());
console.groupEnd();

// Log step data for debugging
console.group('Tutorial Steps Debug');
{% for step in steps %}
console.log('Step {{ step.step_number }}:', {
    id: '{{ step.step_id }}',
    description: '{{ step.description|e }}',
    screenshot: '{{ step.screenshot_path }}',
    coordinates: {{ step.coordinates|tojson if step.coordinates else 'null' }},
    ocr_confidence: {{ step.ocr_confidence or 0 }},
    type: '{{ step.step_type }}'
});
{% endfor %}
console.groupEnd();
{% endblock %}